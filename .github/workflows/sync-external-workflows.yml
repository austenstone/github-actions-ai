name: Sync External Workflow Files

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    # Allow manual triggering
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/sync-external-workflows.yml'

jobs:
  sync-workflows:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT }}
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'

    - name: Create .github/workflows directory
      run: mkdir -p .github/workflows

    - name: Checkout Claude code workflow
      uses: actions/checkout@v4
      with:
        repository: anthropics/claude-code
        sparse-checkout: |
          .github/workflows/claude-issue-triage.yml
        sparse-checkout-cone-mode: false
        path: temp-claude
        
    - name: Copy Claude workflow file
      run: |
        if [ -f "temp-claude/.github/workflows/claude-issue-triage.yml" ]; then
          cp temp-claude/.github/workflows/claude-issue-triage.yml .github/workflows/
          echo "✅ Successfully copied claude-issue-triage.yml"
        else
          echo "⚠️ claude-issue-triage.yml not found"
        fi

    - name: Checkout Gemini CLI workflow
      uses: actions/checkout@v4
      with:
        repository: google-gemini/gemini-cli
        sparse-checkout: |
          .github/workflows/gemini-automated-issue-triage.yml
        sparse-checkout-cone-mode: false
        path: temp-gemini
        
    - name: Copy Gemini workflow file
      run: |
        if [ -f "temp-gemini/.github/workflows/gemini-automated-issue-triage.yml" ]; then
          cp temp-gemini/.github/workflows/gemini-automated-issue-triage.yml .github/workflows/
          echo "✅ Successfully copied gemini-automated-issue-triage.yml"
        else
          echo "⚠️ gemini-automated-issue-triage.yml not found"
        fi

    - name: Create sync summary
      run: |
        echo "# Synced Workflow Files" > .github/workflows/README.md
        echo "" >> .github/workflows/README.md
        echo "This directory contains workflow files synced from external repositories." >> .github/workflows/README.md
        echo "" >> .github/workflows/README.md
        echo "## Sources" >> .github/workflows/README.md
        echo "" >> .github/workflows/README.md
        
        if [ -f ".github/workflows/claude-issue-triage.yml" ]; then
          echo "- **claude-issue-triage.yml**: From [anthropics/claude-code](https://github.com/anthropics/claude-code)" >> .github/workflows/README.md
        fi
        
        if [ -f ".github/workflows/gemini-automated-issue-triage.yml" ]; then
          echo "- **gemini-automated-issue-triage.yml**: From [google-gemini/gemini-cli](https://github.com/google-gemini/gemini-cli)" >> .github/workflows/README.md
        fi
        
        echo "" >> .github/workflows/README.md
        echo "Last updated: $(date -u)" >> .github/workflows/README.md

    - name: Auto commit and push changes
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: |
          🔄 Sync external workflow files
          
          - Updated claude-issue-triage.yml from anthropics/claude-code
          - Updated gemini-automated-issue-triage.yml from google-gemini/gemini-cli
          
          Auto-sync performed on $(date -u)
        file_pattern: '.github/workflows/*.yml .github/workflows/README.md'
        commit_user_name: 'github-actions[bot]'
        commit_user_email: 'github-actions[bot]@users.noreply.github.com'
        skip_dirty_check: false
        skip_fetch: false
        skip_checkout: false

    - name: Create summary
      run: |
        echo "## Sync Summary 📋" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f ".github/workflows/claude-issue-triage.yml" ]; then
          echo "✅ **claude-issue-triage.yml** - Successfully synced from anthropics/claude-code" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **claude-issue-triage.yml** - Failed to sync from anthropics/claude-code" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f ".github/workflows/gemini-automated-issue-triage.yml" ]; then
          echo "✅ **gemini-automated-issue-triage.yml** - Successfully synced from google-gemini/gemini-cli" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ **gemini-automated-issue-triage.yml** - Failed to sync from google-gemini/gemini-cli" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Files are stored in the \`.github/workflows/\` directory." >> $GITHUB_STEP_SUMMARY
